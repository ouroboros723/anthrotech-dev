name: Codeowners merging
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
  pull_request_target:
    types:
      - opened
      - reopened
      - synchronize
  issue_comment:
    types:
      - created
  pull_request_review:
    types:
      - submitted

jobs:
  build-check:
    name: astro-build
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Build with Astro
        id: build
        run: |
          set -o pipefail
          pnpm build 2>&1 | tee build.log
        continue-on-error: true

      - name: Post failure to PR
        if: steps.build.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const log = fs.readFileSync('build.log', 'utf8');
            const truncated = log.length > 6500 ? log.slice(-6500) : log;
            const comment = [
              'üö® **Astro build failed**',
              '',
              '```',
              truncated,
              '```'
            ].join('\n');
            
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: failure
        if: steps.build.outcome == 'failure'
        run: exit 1

  owner-check:
    if: |
      github.event_name == 'pull_request_target' ||
      github.event_name == 'issue_comment' ||
      github.event_name == 'pull_request_review'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      checks: read
    steps:
      - name: Wait for astro-build success (max 5 min)
        uses: actions/github-script@v7
        with:
          script: |
            const targetName = 'astro-build';
            const maxAttempts = 30;        // 30 * 10s = 300s
            const intervalMs = 10_000;

            // PRÁï™Âè∑Ëß£Ê±∫
            let prNumber;
            if (context.eventName === 'pull_request_target') {
              prNumber = context.payload.pull_request.number;
            } else if (context.eventName === 'pull_request_review') {
              prNumber = context.payload.pull_request.number;
            } else if (context.eventName === 'issue_comment') {
              if (!context.payload.issue.pull_request) {
                core.setFailed('Not a PR comment.');
                return;
              }
              prNumber = context.payload.issue.number;
            } else {
              core.setFailed(`Unsupported event: ${context.eventName}`);
              return;
            }

            const sleep = ms => new Promise(r => setTimeout(r, ms));

            // head shaÂèñÂæó
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            const headSha = pr.data.head.sha;

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              const checks = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: headSha,
                filter: 'latest',
                per_page: 100
              });

              const run = checks.data.check_runs.find(r => r.name === targetName);

              if (run) {
                if (run.status === 'completed') {
                  if (run.conclusion === 'success') {
                    core.info(`"${targetName}" succeeded.`);
                    return; // OK
                  } else {
                    core.setFailed(`"${targetName}" failed (conclusion=${run.conclusion}).`);
                    return;
                  }
                }
              }

              if (attempt === maxAttempts) {
                core.setFailed(`"${targetName}" not completed within timeout.`);
                return;
              }

              core.info(`Waiting for "${targetName}"... attempt ${attempt}/${maxAttempts}`);
              await sleep(intervalMs);
            }

      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - name: Run Codeowners merge check
        uses: OSS-Docs-Tools/code-owner-self-merge@1.6.8
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

